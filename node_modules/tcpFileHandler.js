//This file contains code that handles the actual transfer of the files b/w the peers


var net = require('net'),
fs = require('fs'),
stream = require('stream'),
zlib = require('zlib'),
progress = require('progress-stream'),
parseHeader = require('parseIncomingFile.js'),
server = net.createServer(),
events = require('events'),
//lz4 = require('./lz4/lib/lz4.js'),
eventEmitter = new events.EventEmitter();

var DIRNAME = '/home/svn/Documents/ArcleShare/';

//var encoder = lz4.createEncoderStream();

server.listen(8082,function(){

	console.log('A tcp server is listening on port 9090')

});

//The code portion which handles incoming files.
 //for some string related functions
//First we listen for a client to connect to the tcp server.
//after a successful connection, we have the client's socket available to us
//now we listen to tcp stream related events on the socket.
//The main events are 'data', 'end','close', 'timeout','drain','error'

server.on('connection',function(socket){

	console.log('A client with remote address : ' + socket.remoteAddress + ' and port ' + socket.remotePort);

		//we now listen to events on the socket.

		//When there is a data on the stream
		parseHeader(socket,processFile);

	});

var fileTransfer = function(files,dest){ 

	console.log(files);
	console.log(dest);
	var file_index;
	var host_index;

	for(file_index = 0; file_index < files.length ; file_index ++ ){

		for(host_index = 0; host_index < dest.length ; host_index ++){

			function transfer(file_index,host_index){// this is a closure

				var readStream = fs.createReadStream(files[file_index].path);
				var header = files[file_index].name + '\0' + files[file_index].size + '\0' + files[file_index].type;
				var boundary = '\n\n';

				var client = net.connect(8082,dest[host_index].address,function(){

					console.log('client is trying to connect');

				});

				var str = progress({

					length: files[file_index].size,
					time: 100
				});

				console.log(dest);

				client.on('connect',function(){

					console.log('successfully connected! to client ' + dest[host_index].address);
					client.write(header);
					client.write(boundary);
					readStream.pipe(str).pipe(zlib.createGzip()).pipe(client);

				});

				str.on('progress',function(progress){

					//console.log(progress);
					eventEmitter.emit('progress:overall',files[file_index].name,dest[host_index],progress);

				});

				client.on('error',function(){

					console.log('The connection has been closed!');
				});

				client.on('close',function(){

					console.log('The connection with ' + dest[host_index].address + ' has ended');
					console.log('The file ' + files[file_index] + ' has been transferred!');

				});
			}

			transfer(file_index,host_index);

		}
	}

};


eventEmitter.on('file:send:request',function(files,dest){

	fileTransfer(files,dest);

});


//Function to process the file

function processFile(error,header,stream){

	if(error){

		console.log('There\'s an error!');
	}else{


		//var decoder = lz4.createDecoderStream();

		var headers = [];

		headers = header.split('\0');

		var str = progress({

			length : headers[1],
			time : 100
		});

		console.log(headers);

		var writeStream = fs.createWriteStream(DIRNAME + headers[0]);

		stream.pipe(str).pipe(zlib.createGunzip()).pipe(writeStream);

		str.on('progress', function(progress){

			if(progress.remaining == 0){

				stream.end();

			}
			console.log(progress);

			eventEmitter.emit('file:received:progress',progress);

		});

		stream.on('finish',function(){

			console.log('The file '+ headers[0] +' has been successfully received!');

			var options = {

				type : 'text',
				title : 'File Received',
				message : 'The file ' + headers[0] + ' has been received!'
			}

			window.DEA.notifications.create(options, function(target){

				switch(target){

					case 'closer' : console.log('The notification is closed!');
									break;
					case 'primaryButton' : console.log('Primary button is click!');
									break;
					default : console.log('Notification');
				}

			});
		})

		stream.on('error',function(){

			console.log('There\'s an error with the stream!');

		});

	}

}


module.exports = eventEmitter;
