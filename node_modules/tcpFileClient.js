//Sending files to the requesting clients

var net = require('net'),
parseHeader = require('parseIncomingFile.js'),
fs = require('fs'),
stream = require('stream'),
zlib = require('zlib');
progress = require('progress-stream'),
PORT = 8082

	//Client

	var connectToServer = function(serverAddress){

		var client = net.connect(PORT, serverAddress, function(){ });

		client.on('connect', function(){

			console.log('Connection established with server');
			parseHeader(client,processFile);
		});

		client.on('error',function(){

			console.log('Error in connection');
		});

		client.on('close', function(){

			console.log('The connection has been closed!');
		});
	}


	function processFile(error,header,stream){

		if(error){

			console.log('The stream cannot be processed, There is an Error!')

		}else{

			var headers = [];
			headers = header.split('\0');
			console.log(headers);

			var str = progress({

				length : headers[1],
				time : 100
			});

			var outputStream = fs.createWriteStream(headers[0]);
			stream.pipe(str).pipe(outputStream);

			str.on('progress', function(progress){

				console.log(progress);

			});
		}
	}


	module.exports = connectToServer;